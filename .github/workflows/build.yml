---
name: Build container image
on:
  pull_request:
    branches:
      - main
  schedule:
    - cron: '05 11 * * *'  # 10:05am UTC everyday
  push:
    branches:
      - main
    paths-ignore:
      - '**/README.md'
  workflow_dispatch:

env:
  IMAGE_NAME: "ace-os"
  IMAGE_REGISTRY: "ghcr.io/zerixal"
  DEFAULT_TAG: "${{ github.ref_name }}"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}-${{ inputs.brand_name}}-${{ inputs.stream_name }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      tags: ${{ steps.set_tags.outputs.tags }}

    steps:
      - name: Prepare environment
        run: |
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}

      - name: Checkout
        uses: actions/checkout@v5

      # - name: Maximize build space
      #   uses: ublue-os/remove-unwanted-software@cc0becac701cf642c8f0a6613bbdaf5dc36b259e
      #   with:
      #     remove-codeql: true
      #
      - name: Mount BTRFS for podman storage
        id: container-storage-action
        uses: ublue-os/container-storage-action@911baca08baf30c8654933e9e9723cb399892140
        continue-on-error: true
        with:
          target-dir: /var/lib/containers
          mount-opts: compress-force=zstd:2

      - name: Get current date (UTC)
        id: date
        run: |
          echo "date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "short_date=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Set image tags
        id: set_tags
        run: |
          DATE=${{ steps.date.outputs.short_date }}
          TAGS="${DEFAULT_TAG} ${DEFAULT_TAG}.${DATE}"
          echo "TAGS=$TAGS" >> $GITHUB_ENV
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Prepare env
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_REGISTRY: ${{ env.IMAGE_REGISTRY }}
          DEFAULT_TAG: ${{ env.DEFAULT_TAG }}
        run: |
          echo "IMAGE_NAME=${IMAGE_REGISTRY,,}/${IMAGE_NAME,,}" >> ${GITHUB_ENV}
          echo "DEFAULT_TAG=${DEFAULT_TAG,,}" >> ${GITHUB_ENV}

      - name: Build image
        id: build_image
        run: |
          sudo buildah bud \
            --format docker \
            --tag "${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}" \
            --label containers.bootc=1 \
            --label ostree.bootable=1 \
            --file Containerfile

      - name: Save image to docker-archive
        run: |
          sudo buildah push \
            "${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}" \
            "docker-archive:image.tar"

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: image-tar
          path: image.tar

      - name: Cleanup container storage
        run: |
          sudo podman system prune -a -f --volumes || true

  push:
    name: Push
    runs-on: ubuntu-24.04
    needs: build
    if: github.event_name != 'pull_request'
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Prepare environment
        run: |
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
          echo "IMAGE_NAME=${IMAGE_NAME,,}" >> ${GITHUB_ENV}

      - name: Download image artifact
        uses: actions/download-artifact@v7
        with:
          name: image-tar
          path: .

      - name: Set up skopeo
        uses: warjiang/setup-skopeo@v0.1.3
        with:
          version: latest

      - name: Push image via skopeo
        env:
          TAGS: ${{ needs.build.outputs.tags }}
          IMAGE_NAME: ${{ github.event.repository.name }}
          IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
        run: |
          set -euo pipefail
          IMAGE_NAME_LC=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
          IMAGE_REGISTRY_LC=$(echo "${IMAGE_REGISTRY}" | tr '[:upper:]' '[:lower:]')
          for tag in $TAGS; do
            TARGET="docker://${IMAGE_REGISTRY_LC}/${IMAGE_NAME_LC}:${tag}"
            echo "Pushing ${TARGET} from docker-archive:image.tar"
            sudo skopeo copy --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
              "docker-archive:image.tar" \
              "$TARGET"
            echo "Published ${IMAGE_REGISTRY_LC}/${IMAGE_NAME_LC}:${tag}"
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad

      - name: Login to GHCR for Cosign
        run: |
          cosign login ghcr.io -u "${{ github.actor }}" -p "${{ secrets.GITHUB_TOKEN }}"

      - name: Sign container image
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          set -euo pipefail
          IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"
          for tag in ${{ needs.build.outputs.tags }}; do
            echo "Signing ${IMAGE_FULL}:${tag}"
            cosign sign -y --key env://COSIGN_PRIVATE_KEY "${IMAGE_FULL}:${tag}"
          done
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
          COSIGN_EXPERIMENTAL: false
